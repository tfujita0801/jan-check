
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>JAN照合カメラ</title>
  <style>
    body { margin: 0; font-family: sans-serif; text-align: center; background: #222; color: white; }
    #camera, #result { margin-top: 20px; }
    #result { font-size: 2em; }
  </style>
</head>
<body>
  <h1>JANコード照合</h1>
  <video id="camera" autoplay muted playsinline width="320" height="240"></video>
  <div id="result">スキャンを開始中...</div>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    const video = document.getElementById("camera");
    const result = document.getElementById("result");
    let canvas = document.createElement("canvas");
    let ctx = canvas.getContext("2d");
    let scan1 = "", scan2 = "", lock = false;

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => video.srcObject = stream);

    function vibrate(pattern) { if (navigator.vibrate) navigator.vibrate(pattern); }

    function processFrame() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        if (code && !lock) {
          lock = true;
          if (!scan1) {
            scan1 = code.data;
            result.textContent = "1つ目：" + scan1;
          } else {
            scan2 = code.data;
            if (scan1 === scan2) {
              document.body.style.background = "#0a0"; result.textContent = "✅ 一致！";
              vibrate(200);
            } else {
              document.body.style.background = "#a00"; result.textContent = "❌ 不一致！";
              vibrate([200, 100, 200]);
            }
            setTimeout(() => {
              scan1 = ""; scan2 = "";
              document.body.style.background = "#222";
              result.textContent = "スキャンを再開します...";
              lock = false;
            }, 2000);
            return;
          }
          setTimeout(() => lock = false, 2000);
        }
      }
      requestAnimationFrame(processFrame);
    }

    requestAnimationFrame(processFrame);
  </script>
</body>
</html>
