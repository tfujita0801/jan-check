
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>JANコード照合</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 0; padding: 0; }
    #reader { width: 100%; max-width: 480px; margin: auto; }
    #status { font-size: 1.5em; margin: 10px; padding: 20px; }
  </style>
</head>
<body>
  <h2>JANコード照合アプリ</h2>
  <div id="reader"></div>
  <div id="status">スキャン待機中…</div>
  <script>
    let firstScan = "";
    let scanning = true;
    const statusDiv = document.getElementById("status");

    function vibrate(pattern) {
      if (navigator.vibrate) navigator.vibrate(pattern);
    }

    function setStatus(text, color) {
      statusDiv.innerText = text;
      statusDiv.style.background = color;
    }

    function resetScan() {
      firstScan = "";
      setStatus("スキャン待機中…", "white");
      scanning = true;
    }

    function onScanSuccess(decodedText, decodedResult) {
      if (!scanning) return;
      scanning = false;

      if (firstScan === "") {
        firstScan = decodedText;
        setStatus("2つ目のJANコードをスキャンしてください", "#e0f7fa");
        scanning = true;
        return;
      }

      if (decodedText === firstScan) {
        setStatus("✅ 一致しました", "#c8e6c9");
        vibrate([200]);
      } else {
        setStatus("❌ 一致しません", "#ffcdd2");
        vibrate([200, 100, 200]);
      }

      setTimeout(resetScan, 2000);
    }

    const html5QrCode = new Html5Qrcode("reader", { formatsToSupport: [ Html5QrcodeSupportedFormats.CODE_128, Html5QrcodeSupportedFormats.EAN_13 ] });

    Html5Qrcode.getCameras().then(devices => {
      if (devices.length) {
        let backCamera = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];
        html5QrCode.start(
          backCamera.id,
          { fps: 10, qrbox: 250 },
          onScanSuccess
        ).catch(err => {
          setStatus("カメラの起動に失敗しました", "#f8d7da");
        });
      }
    }).catch(err => {
      setStatus("カメラが見つかりません", "#f8d7da");
    });
  </script>
</body>
</html>
