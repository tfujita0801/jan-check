<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>JANコード照合 v2.2</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #fff; margin: 0; padding: 2em; }
    video { width: 100%; max-width: 400px; border: 1px solid #ccc; }
    .result { font-size: 2em; margin-top: 1em; }
    .match { background-color: #d4ffd4; color: green; }
    .mismatch { background-color: #ffe5e5; color: red; }
  </style>
</head>
<body>
  <h1>JANコード照合</h1>
  <video id="video" autoplay></video>
  <div class="result" id="result">スキャン待機中...</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <script>
    let firstScan = null;
    let scanLock = false;

    function vibrate(pattern) {
      if (navigator.vibrate) navigator.vibrate(pattern);
    }

    function setResult(text, matched) {
      const result = document.getElementById("result");
      result.textContent = text;
      result.className = "result " + (matched ? "match" : "mismatch");
    }

    Quagga.init({
      inputStream: {
        type: "LiveStream",
        target: document.querySelector("#video"),
        constraints: {
          facingMode: "environment" // 背面カメラ指定
        }
      },
      decoder: {
        readers: ["ean_reader"] // JAN/EAN対応
      }
    }, function(err) {
      if (err) return console.error(err);
      Quagga.start();
    });

    Quagga.onDetected(function(data) {
      if (scanLock) return;
      const code = data.codeResult.code;
      scanLock = true;

      if (!firstScan) {
        firstScan = code;
        setResult("1つ目スキャン: " + code, false);
        vibrate([100]);
      } else {
        if (code === firstScan) {
          setResult("一致！" + code, true);
          vibrate([200]);
        } else {
          setResult("不一致！" + code, false);
          vibrate([100, 100, 100]);
        }
        setTimeout(() => {
          firstScan = null;
          setResult("スキャン待機中...", false);
          scanLock = false;
        }, 2000);
        return;
      }

      setTimeout(() => { scanLock = false; }, 2000);
    });
  </script>
</body>
</html>
