
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>JAN照合カメラ（背面固定）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; margin: 0; padding: 1em; background: #f0f0f0; }
    #result { font-size: 2em; margin-top: 1em; text-align: center; }
    video { width: 100%; height: auto; }
    .matched { background: #c8f7c5; }
    .unmatched { background: #f7c5c5; }
  </style>
</head>
<body>
  <h2>JAN照合カメラ（背面固定）</h2>
  <video id="video" autoplay></video>
  <div id="result">スキャン待機中...</div>
  <script type="module">
    import QrScanner from "https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js";

    const videoElem = document.getElementById("video");
    const resultElem = document.getElementById("result");

    let firstCode = null;
    let canScan = true;

    async function setupCamera() {
      const devices = await QrScanner.listVideoInputDevices();
      const backCamera = devices[1] || devices[0];
      const scanner = new QrScanner(videoElem, result => onScan(result), {
        highlightScanRegion: true,
        returnDetailedScanResult: true,
        deviceId: backCamera.id,
      });
      scanner.start();
    }

    function vibrate(pattern) {
      if (navigator.vibrate) navigator.vibrate(pattern);
    }

    function onScan(result) {
      if (!canScan) return;
      canScan = false;

      if (!firstCode) {
        firstCode = result.data;
        resultElem.innerText = "1件目読み取り：" + firstCode;
        canScan = true;
      } else {
        const secondCode = result.data;
        if (firstCode === secondCode) {
          resultElem.innerText = "✅ 一致：" + secondCode;
          document.body.className = "matched";
          vibrate(200);
        } else {
          resultElem.innerText = "❌ 不一致：" + secondCode;
          document.body.className = "unmatched";
          vibrate([200, 100, 200]);
        }
        setTimeout(() => {
          resultElem.innerText = "スキャン待機中...";
          document.body.className = "";
          firstCode = null;
          canScan = true;
        }, 2000);
      }
    }

    setupCamera();
  </script>
</body>
</html>
